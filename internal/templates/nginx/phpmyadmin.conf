# WebStack CLI - phpMyAdmin nginx Configuration
# Variables: {{.PHPVersion}}

server {
	listen 80;
	server_name _;
	root /var/www;

	location /phpmyadmin/ {
		alias /var/www/phpmyadmin/;
		index index.php;

		# Deny access to sensitive directories
		location ~ /(libraries|setup|templates|locale) {
			deny all;
			return 404;
		}

		# Deny access to sensitive files
		location ~ /(.+\.(json|lock|md|sql)) {
			deny all;
			return 404;
		}

		# PHP processing for phpmyadmin
		location ~ ^/phpmyadmin/(.*\.php)$ {
			try_files $uri =404;
            fastcgi_split_path_info ^(.+\.php)(/.+)$;
			include /etc/nginx/fastcgi_params;
			fastcgi_index index.php;
			fastcgi_param SCRIPT_FILENAME /var/www/phpmyadmin/$1;
			fastcgi_pass unix:/run/php/php{{.PHPVersion}}-fpm.sock;
		}

		# Static files for phpmyadmin
		location ~ /phpmyadmin/(.+\.(jpg|jpeg|gif|css|png|webp|js|ico|html|xml|txt|woff|woff2|ttf))$ {
			root /var/www;
			expires 30d;
			add_header Cache-Control "public, immutable";
			access_log off;
		}

		# Fallback to index.php
		try_files $uri $uri/ /phpmyadmin/index.php$is_args$args;
	}
}