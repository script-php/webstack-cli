######################################################################
#                  Exim4 Mail Server Configuration                    #
#                    Generated by WebStack CLI                        #
######################################################################

# Enable/disable features
#SPAMASSASSIN = yes
#SPAM_SCORE = 50
#SPAM_REJECT_SCORE = 100
#CLAMD = yes

# SMTP Configuration
smtp_banner = $smtp_active_hostname
smtp_active_hostname = {{.Hostname}}
add_environment = <; PATH=/bin:/usr/bin
keep_environment =
disable_ipv6 = false
smtp_accept_max = 100
smtp_accept_max_per_host = 20

# Domain Lists
domainlist local_domains = dsearch;/etc/exim4/domains/
domainlist relay_to_domains = dsearch;/etc/exim4/domains/
hostlist relay_from_hosts = 127.0.0.1
hostlist whitelist = net-iplsearch;/etc/exim4/white-blocks.conf
hostlist spammers = net-iplsearch;/etc/exim4/spam-blocks.conf

# ACL Configuration
no_local_from_check
untrusted_set_sender = *
acl_smtp_connect = acl_check_spammers
acl_smtp_mail = acl_check_mail
acl_smtp_rcpt = acl_check_rcpt
acl_smtp_data = acl_check_data
acl_smtp_mime = acl_check_mime

# SpamAssassin Integration
.ifdef SPAMASSASSIN
spamd_address = 127.0.0.1 783
.endif

# ClamAV Integration
.ifdef CLAMD
av_scanner = clamd: /run/clamav/clamd.ctl
.endif

# Logging
log_selector = +tls_sni
log_file_path = /var/log/exim4/mainlog

# TLS Configuration
tls_advertise_hosts = *
tls_certificate = /etc/ssl/certs/webstack-mail.crt
tls_privatekey = /etc/ssl/private/webstack-mail.key
daemon_smtp_ports = 25 : 465 : 587
tls_on_connect_ports = 465
tls_require_ciphers = PERFORMANCE:-RSA:-VERS-ALL:+VERS-TLS1.2:+VERS-TLS1.3:%SERVER_PRECEDENCE

# Authentication
auth_advertise_hosts = localhost : ${if eq{$tls_in_cipher}{}{}{*}}
never_users = root

# DNS and Connection Settings
host_lookup = *
rfc1413_hosts = *
rfc1413_query_timeout = 0s
ignore_bounce_errors_after = 2d
timeout_frozen_after = 7d

# DKIM Configuration
DKIM_DOMAIN = {{.Domain}}
DKIM_FILE = /etc/exim4/domains/{{.Domain}}/dkim.pem
DKIM_PRIVATE_KEY = ${if exists{DKIM_FILE}{DKIM_FILE}{0}}

# System Filter
system_filter = /etc/exim4/system.filter
system_filter_user = Debian-exim

######################################################################
#                       ACL CONFIGURATION                            #
######################################################################

begin acl

# Rate limit for website forms
acl_not_smtp:
  deny    message       = Website sending too many emails
          ratelimit     = 200 / 1h / $authenticated_id

  accept

# Spammer check
acl_check_spammers:
  accept  hosts         = +whitelist
  drop    message       = Your host is blacklisted
          log_message   = Host in blacklist
          hosts         = +spammers
  accept

# MAIL command ACL
acl_check_mail:
  deny  condition     = ${if eq{$sender_helo_name}{}}
        message       = HELO required
  accept

# RCPT command ACL
acl_check_rcpt:
  accept  hosts         = :
  
  deny    message       = Too many emails from this account
          set acl_c_msg_limit = 100
          ratelimit     = $acl_c_msg_limit / 1h / strict / $authenticated_id

  require verify        = sender
  accept  hosts         = +relay_from_hosts
  accept  authenticated = *
  deny    message       = Relay not permitted
          domains       = !+local_domains
  require verify        = recipient
  accept

# Data ACL
acl_check_data:
.ifdef CLAMD
  deny   message        = Message contains virus
         malware        = */defer_ok
.endif

.ifdef SPAMASSASSIN
  warn   spam           = debian-spamd:true
         add_header     = X-Spam-Score: $spam_score_int
         add_header     = X-Spam-Status: $spam_flag
.endif

  accept

# MIME ACL
acl_check_mime:
  accept

######################################################################
#                   AUTHENTICATION CONFIGURATION                     #
######################################################################

begin authenticators

dovecot_plain:
  driver = dovecot
  public_name = PLAIN
  server_socket = /run/dovecot/auth-client
  server_set_id = $auth1

dovecot_login:
  driver = dovecot
  public_name = LOGIN
  server_socket = /run/dovecot/auth-client
  server_set_id = $auth1

######################################################################
#                      ROUTERS CONFIGURATION                         #
######################################################################

begin routers

userforward:
  driver = redirect
  check_local_user
  file = $home/.forward
  domains = +local_domains
  allow_filter
  no_verify
  no_expn
  file_transport = address_file
  pipe_transport = address_pipe
  reply_transport = address_reply

aliases:
  driver = redirect
  data = ${extract{1}{:}{${lookup{$local_part@$domain}lsearch{/etc/exim4/domains/$domain/aliases}}}}
  require_files = /etc/exim4/domains/$domain/aliases
  redirect_router = dnslookup
  pipe_transport = address_pipe
  unseen

dnslookup:
  driver = dnslookup
  domains = !+local_domains
  transport = remote_smtp

localuser:
  driver = accept
  transport = local_delivery
  condition = ${lookup{$local_part}lsearch{/etc/exim4/domains/$domain/passwd}{true}{false}}

######################################################################
#                      TRANSPORTS CONFIGURATION                      #
######################################################################

begin transports

remote_smtp:
  driver = smtp
  dkim_domain = DKIM_DOMAIN
  dkim_selector = mail
  dkim_private_key = DKIM_PRIVATE_KEY
  dkim_canon = relaxed

local_delivery:
  driver = appendfile
  maildir_format
  maildir_use_size_file
  user = mail
  group = mail
  create_directory
  directory_mode = 770
  mode = 660
  use_lockfile = no
  delivery_date_add
  envelope_to_add
  return_path_add
  directory = /var/mail/vhosts/$domain/$local_part
  quota = 1024M

address_file:
  driver = appendfile
  delivery_date_add
  envelope_to_add
  return_path_add

address_pipe:
  driver = pipe
  return_output

address_reply:
  driver = autoreply

######################################################################
#                      RETRY CONFIGURATION                           #
######################################################################

begin retry

*     *     F,2h,15m; G,16h,1h,1.5; F,4d,6h

######################################################################
#                      REWRITE CONFIGURATION                         #
######################################################################

begin rewrite
