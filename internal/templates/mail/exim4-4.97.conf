######################################################################
#                  Exim4 Mail Server Configuration                    #
#               WebStack CLI - Compatible with v4.97                 #
######################################################################

# ===== Main Configuration =====

primary_hostname = localhost.localdomain
qualify_domain = localhost.localdomain
smtp_banner = $smtp_active_hostname ESMTP Exim $version_number

# Security - Never run as these users
never_users = root : bin : daemon : nobody

# Logging Configuration
log_selector = +smtp_protocol_error +smtp_syntax_error +tls_peerdn +tls_sni +received_recipients
log_file_path = /var/log/exim4/%s/mainlog

# SMTP Configuration
smtp_accept_max = 100
smtp_accept_max_per_host = 20
smtp_accept_reserve = 10

# ACL hooks
acl_smtp_connect = acl_check_spammers
acl_smtp_rcpt = acl_check_rcpt
acl_smtp_data = acl_check_data

# Domain and Host Lists
domainlist local_domains = dsearch;/etc/exim4/domains/
domainlist relay_to_domains = dsearch;/etc/exim4/domains/
hostlist relay_from_hosts = 127.0.0.1

# DNSBL and spam blocking lists
hostlist spammers = net-iplsearch;/etc/exim4/spam-blocks.conf
hostlist whitelist = net-iplsearch;/etc/exim4/white-blocks.conf

# SMTP Relay Configuration
SMTP_RELAY_FILE = ${if exists{/etc/exim4/domains/$sender_address_domain/smtp_relay.conf}{/etc/exim4/domains/$sender_address_domain/smtp_relay.conf}{/etc/exim4/smtp_relay.conf}}
SMTP_RELAY_HOST = ${lookup{host}lsearch{SMTP_RELAY_FILE}}
SMTP_RELAY_PORT = ${lookup{port}lsearch{SMTP_RELAY_FILE}}
SMTP_RELAY_USER = ${lookup{user}lsearch{SMTP_RELAY_FILE}}
SMTP_RELAY_PASS = ${lookup{pass}lsearch{SMTP_RELAY_FILE}}

# ===== SRS (Sender Rewriting Scheme) Configuration =====
# SRS helps maintain SPF compliance for forwarded/relayed emails
# Rewrites sender domain to prevent SPF failures on forwarded messages

# SRS Secret Key (for encoding/decoding)
# Should be a 16+ character random string
SRS_SECRET = webstack-srs-secret-key-v1

# SRS Domain (domain to use for rewritten addresses)
# Uses local domain if not configured
SRS_DOMAIN = ${if exists{/etc/exim4/srs.conf}{${readfile{/etc/exim4/srs.conf}}}{webstack-srs}}

# ===== TLS/SSL Configuration =====

tls_advertise_hosts = *

# Dynamic SSL per domain - checks for domain-specific cert, falls back to default
# Allows SNI-based multi-domain TLS support
tls_certificate = \
        ${if and {\
                     { eq {${domain:test@$tls_in_sni}} {$tls_in_sni}}\
                     { exists{/etc/ssl/certs/webstack-$tls_in_sni.crt} }\
                 }\
                 {/etc/ssl/certs/webstack-$tls_in_sni.crt}\
                 {/etc/ssl/certs/webstack-mail.crt}\
         }

tls_privatekey = \
        ${if and {\
                     { eq {${domain:test@$tls_in_sni}} {$tls_in_sni}}\
                     { exists{/etc/ssl/private/webstack-$tls_in_sni.key} }\
                 }\
                 {/etc/ssl/private/webstack-$tls_in_sni.key}\
                 {/etc/ssl/private/webstack-mail.key}\
         }

# SMTP ports configuration
daemon_smtp_ports = 25 : 465 : 587
tls_on_connect_ports = 465

# TLS security settings
tls_require_ciphers = PERFORMANCE:-RSA:-VERS-ALL:+VERS-TLS1.2:+VERS-TLS1.3:%SERVER_PRECEDENCE
tls_dh_max_bits = 2048

# ===== Authentication =====

auth_advertise_hosts = localhost : ${if eq{$tls_in_cipher}{}{}{*}}

# ===== DKIM Configuration =====

# Set dynamically per domain
DKIM_DOMAIN = $domain
DKIM_FILE = /etc/exim4/domains/$domain/dkim.private
DKIM_SELECTOR = mail

# ===== System Filter =====

system_filter = /etc/exim4/system.filter
system_filter_user = Debian-exim

# ===== DNS and Connection Settings =====

host_lookup = *
rfc1413_hosts = *
rfc1413_query_timeout = 5s
ignore_bounce_errors_after = 2d
timeout_frozen_after = 7d

# ===== Timeout Settings =====

receive_timeout = 0s
smtp_receive_timeout = 5m

######################################################################
#                      ACL CONFIGURATION                             #
######################################################################

begin acls

# Connection level spam checking
acl_check_spammers:
  # Reject if IP is on local spam blocklist
  deny    hosts        = +spammers
          message      = Host $sender_host_address blocked by local policy

  # DNSBL checks (SpamCop, Spamhaus Zen, etc.)
  deny    dnslists     = zen.spamhaus.org : bl.spamcop.net
          message      = Host listed in DNSBL: $dnslist_domain
          log_message  = $sender_host_address listed in $dnslist_domain

  # Whitelist bypass
  accept  hosts        = +whitelist

  accept

# Recipient Command ACL (RCPT TO)
acl_check_rcpt:
  # Local submissions
  accept  hosts         = :
  
  # Authenticated users can relay
  accept  authenticated = *
  
  # Accept mail to local domains
  accept  domains       = +local_domains
          verify        = recipient/callout=no,defer_ok
  
  # Accept relaying from whitelist
  accept  hosts         = +relay_from_hosts
          domains       = +relay_to_domains
  
  # Everything else is denied
  deny    message       = Relay not permitted

# Data ACL (message content)
acl_check_data:
  accept

######################################################################
#                   AUTHENTICATORS CONFIGURATION                     #
######################################################################

begin authenticators

# PLAIN authentication via passwd file
plain_auth:
  driver               = plaintext
  public_name          = PLAIN
  server_prompts       = :
  server_condition     = ${if exists{/etc/exim4/domains/$domain/passwd}{yes}{no}}
  server_set_id        = $auth2

######################################################################
#                      ROUTERS CONFIGURATION                         #
######################################################################

begin routers

# Check for aliases first
alias_router:
  driver               = redirect
  domains              = +local_domains
  data                 = ${extract{1}{:}{${lookup{$local_part}lsearch*@{/etc/exim4/domains/$domain/aliases}}}}
  require_files        = /etc/exim4/domains/$domain/aliases
  allow_fail
  redirect_router      = local_user
  pipe_transport       = address_pipe

# SRS (Sender Rewriting Scheme) for forwarded/aliased emails
# Handles bounce messages from forwarded addresses
# Detects SRS rewritten addresses and rewrites them back to original sender
srs_bounce_router:
  driver               = redirect
  senders              = *-+SRS_SECRET@*
  data                 = ${srs_reverse:$local_part}
  redirect_router      = local_user

# Remote domains - send via DNS
dnslookup:
  driver               = dnslookup
  domains              = !+local_domains
  transport            = remote_smtp
  ignore_target_hosts  = 127.0.0.0/8 : ::1
  no_more

# Local user delivery
local_user:
  driver               = accept
  domains              = +local_domains
  condition            = ${if exists{/etc/exim4/domains/$domain/passwd}{yes}{no}}
  transport            = virtual_delivery
  user                 = mail
  group                = mail

######################################################################
#                      TRANSPORTS CONFIGURATION                      #
######################################################################

begin transports

# Virtual user maildir delivery
virtual_delivery:
  driver               = appendfile
  directory            = /var/mail/vhosts/$domain/$local_part
  maildir_format       = true
  create_directory     = true
  directory_mode       = 0770
  mode                 = 0660
  use_lockfile         = false
  delivery_date_add
  envelope_to_add
  return_path_add
  user                 = mail
  group                = mail

# Remote SMTP delivery
remote_smtp:
  driver               = smtp
  
  # SMTP relay support - use domain-specific relay if configured
  .ifdef RELAY_ENABLED
  hosts                = SMTP_RELAY_HOST
  port                 = SMTP_RELAY_PORT
  hosts_require_auth   = SMTP_RELAY_HOST
  .endif
  
  # DKIM signing
  dkim_domain          = $domain
  dkim_selector        = mail
  dkim_private_key     = ${if exists{/etc/exim4/domains/$domain/dkim.private}{/etc/exim4/domains/$domain/dkim.private}{0}}
  dkim_canon           = relaxed/relaxed
  dkim_sign_headers    = from : to : date : subject : message-id : content-type
  
  # TLS support
  tls_verify_hosts     = *

# Pipe transport for .forward programs
address_pipe:
  driver               = pipe
  return_output
  user                 = mail
  group                = mail

######################################################################
#                      RETRY CONFIGURATION                           #
######################################################################

begin retry

*                      *  F,2h,15m; G,16h,1h,1.5; F,4d,6h
