# WebStack CLI - Apache Domain Template
# Variables: {{.Domain}}, {{.DocumentRoot}}, {{.PHPVersion}}, {{.ApachePort}}

<VirtualHost *:{{.ApachePort}}>
    ServerName {{.Domain}}
    DocumentRoot {{.DocumentRoot}}
    
    # Logging
    CustomLog /var/log/apache2/{{.Domain}}.access.log combined
    ErrorLog /var/log/apache2/{{.Domain}}.error.log
    LogLevel warn

    # Directory settings
    <Directory {{.DocumentRoot}}>
        AllowOverride All
        Options +Includes -Indexes +ExecCGI
        Require all granted
        
        # PHP configuration
        <IfModule mod_php{{.PHPVersion}}.c>
            php_admin_value open_basedir {{.DocumentRoot}}:/tmp
            php_admin_value upload_tmp_dir /tmp
            php_admin_value session.save_path /tmp
            php_admin_value sys_temp_dir /tmp
        </IfModule>
    </Directory>

    # PHP-FPM via proxy_fcgi (preferred when mod_php is not installed)
    <IfModule proxy_fcgi_module>
        # Ensure PHP files are passed to php-fpm socket
        ProxyPassMatch "^/(.*\\.php(/.*)?)$" "unix:/run/php/php{{.PHPVersion}}-fpm.sock|fcgi://localhost{{.DocumentRoot}}/"
    </IfModule>

    # Security
    <Files ".ht*">
        Require all denied
    </Files>
    
    <Files "*.ini">
        Require all denied
    </Files>
    
    <Files "*.log">
        Require all denied
    </Files>

    # Error pages
    ErrorDocument 403 /error/403.html
    ErrorDocument 404 /error/404.html
    ErrorDocument 500 /error/50x.html
    ErrorDocument 501 /error/50x.html
    ErrorDocument 502 /error/50x.html
    ErrorDocument 503 /error/50x.html
    ErrorDocument 506 /error/50x.html
    
    Alias /error/ {{.DocumentRoot}}/../error/
    <Directory "{{.DocumentRoot}}/../error/">
        AllowOverride None
        Options -Indexes
        Require all granted
    </Directory>

    # Set real IP from Nginx proxy
    <IfModule mod_remoteip.c>
        RemoteIPHeader X-Real-IP
        RemoteIPTrustedProxy 127.0.0.1
    </IfModule>
</VirtualHost>